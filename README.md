# Subscription Service

REST-сервис для управления информацией об онлайн-подписках пользователей. Сервис предоставляет CRUDL-операции, а также функциональность для расчёта суммарной стоимости подписок за выбранный период с возможностью фильтрации.

---

## 1. Функциональные возможности

* Создание новой подписки.
* Получение информации о подписке по `id`.
* Частичное обновление данных подписки.
* Удаление подписки.
* Получение списка подписок с поддержкой фильтрации и пагинации.
* Расчёт общей стоимости подписок за указанный период с фильтрацией по пользователю и названию сервиса.
* Защита от создания подписок с пересекающимися периодами для одного пользователя и одного сервиса.

---

## 2. Используемые технологии

* **Язык программирования**: Go 1.23.4
* **База данных**: PostgreSQL
* **ORM**: GORM
* **Документация API**: Swagger (swaggo/swag)
* **Контейнеризация**: Docker, Docker Compose
* **Миграции БД**: SQL-скрипты
* **Логирование**: slog
* **Загрузка конфигурации**: godotenv
* **Защита от пересекающихся подписок**: PostgreSQL `btree_gist` и `EXCLUDE` constraint

---

## 3. Архитектура проекта

```
├── cmd/                        # Точка входа в приложение
│   └── server/main.go
├── internal/
│   ├── config/                 # Загрузка конфигурации
│   ├── controller/             # HTTP-обработчики
│   ├── docs/                   # Swagger-документация
│   ├── models/                 # Модели и DTO
│   ├── repository/
│   │   └── postgres/           # Доступ к БД через GORM
│   └── service/                # Бизнес-логика
├── migrations/                 # SQL-миграции
├── pkg/
│   └── logging/                # Логирование
├── .env                        # Конфигурация окружения
├── .env.example                # Пример конфигурации
├── .gitignore
├── docker-compose.yml          # Docker Compose конфигурация
├── Dockerfile                  # Docker образ приложения
├── go.mod                      # Go modules
├── go.sum
├── LICENSE
└── README.md

```

---

## 4. Описание API

### 4.1. POST `/api/subscriptions`

Создание новой подписки.
**Поля запроса**:

* `service_name` — строка, название сервиса;
* `price` — целое число, цена в рублях;
* `user_id` — UUID пользователя;
* `start_date` — месяц и год начала (`MM-YYYY`);
* `end_date` *(опционально)* — месяц и год окончания (`MM-YYYY`).

**Примечание:** сервис запрещает создание подписок с одинаковыми `(user_id, service_name)`, пересекающимися по датам.

---

### 4.2. GET `/api/subscriptions/{id}`

Получение данных подписки по идентификатору (UUID).

---

### 4.3. GET `/api/subscriptions`

Получение списка подписок с фильтрацией и пагинацией.
**Параметры**:

* `user_id` *(опционально)* — фильтр по пользователю;
* `service_name` *(опционально)* — фильтр по названию сервиса;
* `limit` *(опционально)* — количество элементов на странице (по умолчанию 20);
* `offset` *(опционально)* — смещение (по умолчанию 0).

---

### 4.4. PATCH `/api/subscriptions/{id}`

Частичное обновление данных подписки.

---

### 4.5. DELETE `/api/subscriptions/{id}`

Удаление подписки.

---

### 4.6. GET `/api/subscriptions/total`

Расчёт суммарной стоимости подписок за период.
**Параметры**:

* `from` — месяц и год начала (`MM-YYYY`);
* `to` — месяц и год окончания (`MM-YYYY`);
* `user_id` *(опционально)* — фильтр по пользователю;
* `service_name` *(опционально)* — фильтр по названию сервиса.

**Принцип работы**:

1. Выбираются подписки, которые пересекаются с указанным периодом.
2. Для каждой подписки вычисляется количество оплачиваемых месяцев.
3. Результат суммируется с учётом уникальности месяца и сервиса на пользователя.

---

## 5. Запуск приложения

### 5.1. Предварительные требования

* Docker и Docker Compose.
* Go 1.23.4 (для локального запуска без контейнера).

### 5.2. Конфигурация

Файл `.env`:

```env
DB_HOST=postgres
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=subscriptions
SERVER_PORT=8080
```

### 5.3. Запуск в Docker

```bash
docker compose up --build
```

Сервис будет доступен по адресу:
`http://localhost:8080`

#### Документация Swagger:
`http://localhost:8080/swagger/index.html`

---

## 6. Тестирование

1. Открыть Swagger UI.
2. Создать подписку через `POST /api/subscriptions`.
3. Полученный `id` использовать в других методах (`GET`, `PATCH`, `DELETE`).
4. Для проверки расчёта стоимости использовать метод `/api/subscriptions/total`.


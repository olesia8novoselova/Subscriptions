# Subscription Service

REST-сервис для управления информацией об онлайн-подписках пользователей.
Сервис реализует CRUDL-операции, а также функциональность расчёта суммарной стоимости подписок за выбранный период с возможностью фильтрации.

Проект сопровождается **юнит-тестами** для бизнес-логики и контроллеров, а также **CI/CD пайплайном** (GitHub Actions) для автоматической сборки, линтинга, тестирования и деплоя.

---

## 1. Функциональные возможности

* Создание новой подписки.
* Получение информации о подписке по `id`.
* Частичное обновление данных подписки.
* Удаление подписки.
* Получение списка подписок с поддержкой фильтрации и пагинации.
* Расчёт общей стоимости подписок за указанный период с фильтрацией по пользователю и названию сервиса.
* Защита от создания подписок с пересекающимися периодами для одного пользователя и одного сервиса.

---

## 2. Используемые технологии

* **Язык программирования**: Go 1.23.4
* **База данных**: PostgreSQL
* **ORM**: GORM
* **Документация API**: Swagger (swaggo/swag)
* **Контейнеризация**: Docker, Docker Compose
* **Миграции БД**: SQL-скрипты
* **Логирование**: slog
* **Загрузка конфигурации**: godotenv
* **Линтинг**: golangci-lint
* **CI/CD**: GitHub Actions
* **Тестирование**: Go testing framework (`testing`)

---

## 3. Архитектура проекта

```
├── cmd/server/                   # Точка входа в приложение
├── internal/
│   ├── config/                   # Загрузка конфигурации
│   ├── controller/               # HTTP-обработчики
│   ├── service/                  # Бизнес-логика приложения
│   ├── repository/
│   │   └── postgres/             # Доступ к БД (GORM)
│   ├── models/                   # Модели данных и DTO
│   ├── docs/                     # Swagger-документация
├── migrations/                   # SQL-миграции базы данных
├── pkg/
│   └── logging/                  # Логирование
├── .github/workflows/            # CI/CD пайплайны
├── docker-compose.yml            # Описание сервисов Docker
├── Dockerfile                    # Образ приложения
├── .env                          # Конфигурация окружения
├── .env.example                  # Пример конфигурации
├── .golangci.yml                 # Конфигурация линтера
├── go.mod                        # Модули Go
├── go.sum                        # Контрольные суммы зависимостей
├── LICENSE                       # Лицензия проекта
└── README.md                     # Документация проекта

```

---
## 4. CI/CD

Проект использует **GitHub Actions** для автоматизации:

* **CI**:

  * Сборка проекта.
  * Линтинг кода (`golangci-lint`).
  * Запуск юнит-тестов.

* **CD**:

  * Автоматический деплой (DockerHub).

Конфигурация находится в `.github/workflows/ci-cd.yml`.

---


## 5. Описание API

### 5.1. POST `/api/subscriptions`

Создание новой подписки.
**Поля запроса**:

* `service_name` — строка, название сервиса;
* `price` — целое число, цена в рублях;
* `user_id` — UUID пользователя;
* `start_date` — месяц и год начала (`MM-YYYY`);
* `end_date` *(опционально)* — месяц и год окончания (`MM-YYYY`).

**Примечание:** сервис запрещает создание подписок с одинаковыми `(user_id, service_name)`, пересекающимися по датам.

---

### 5.2. GET `/api/subscriptions/{id}`

Получение данных подписки по идентификатору (UUID).

---

### 5.3. GET `/api/subscriptions`

Получение списка подписок с фильтрацией и пагинацией.
**Параметры**:

* `user_id` *(опционально)* — фильтр по пользователю;
* `service_name` *(опционально)* — фильтр по названию сервиса;
* `limit` *(опционально)* — количество элементов на странице (по умолчанию 20);
* `offset` *(опционально)* — смещение (по умолчанию 0).

---

### 5.4. PATCH `/api/subscriptions/{id}`

Частичное обновление данных подписки.

---

### 5.5. DELETE `/api/subscriptions/{id}`

Удаление подписки.

---

### 5.6. GET `/api/subscriptions/total`

Расчёт суммарной стоимости подписок за период.
**Параметры**:

* `from` — месяц и год начала (`MM-YYYY`);
* `to` — месяц и год окончания (`MM-YYYY`);
* `user_id` *(опционально)* — фильтр по пользователю;
* `service_name` *(опционально)* — фильтр по названию сервиса.

**Принцип работы**:

1. Выбираются подписки, которые пересекаются с указанным периодом.
2. Для каждой подписки вычисляется количество оплачиваемых месяцев.
3. Результат суммируется с учётом уникальности месяца и сервиса на пользователя.

---

## 6. Запуск приложения

### 6.1. Предварительные требования

* Docker и Docker Compose.
* Go 1.23.4 (для локального запуска без контейнера).

### 6.2. Конфигурация

Пример файла .env представлен в `.env.example`.

### 6.3. Запуск в Docker

```bash
docker compose up --build
```

Сервис будет доступен по адресу:
`http://localhost:8080`

#### Документация Swagger:
`http://localhost:8080/swagger/index.html`

---

## 7. Тестирование

1. Открыть Swagger UI.
2. Создать подписку через `POST /api/subscriptions`.
3. Полученный `id` использовать в других методах (`GET`, `PATCH`, `DELETE`).
4. Для проверки расчёта стоимости использовать метод `/api/subscriptions/total`.

В проекте реализованы **юнит-тесты** для:

* Бизнес-логики (`internal/service`).
* HTTP-обработчиков (`internal/controller`).

Для запуска тестов:

```bash
go test ./... -v
```

Отчёт о тестах и линтинге автоматически формируется в CI.

---
